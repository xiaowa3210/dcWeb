{% extends 'back01/base.html' %}

{% block static_files %}
<script type="text/javascript" src="/static/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="/static/ueditor/ueditor.all.js"></script>
<script src="/static/js/jquery-2.1.0.min.js"></script>
{% endblock %}

{% block body_part %}

<section id="main-content">
    <section class="wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="page-header"><i class="fa fa-files-o"></i>修改文章</h3>
                <ol class="breadcrumb">
                    <li><i class="fa fa-home"></i><a href="index.html">主页</a></li>
                    <li><i class="icon_document_alt"></i>文章管理</li>
                    <li><i class="fa fa-files-o"></i>修改文章</li>
                </ol>
            </div>
        </div>
        <!-- Form validations -->
        <div class="row" id="article_id" article_id="{{article.article_id}}">
            <div class="col-lg-12">
                <section class="panel">
                    <header class="panel-heading">
                        添加项目
                    </header>
                    <div class="panel-body">
                        <div class="form article">
                            <form id="articleform" class="form-horizontal" onsubmit="return false" action="##" method="post">
                                <div class="form-group ">
                                    <label for="title" class="control-label col-lg-2">标题<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                        <input class="form-control title" id="title" name="title"
                                               type="text" value="{{article.title}}" required />
                                    </div>
                                </div>

                                <div class="form-group ">
                                    <label for="subtitle" class="control-label col-lg-2">副标题<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                        <input class="form-control subtitle" id="subtitle" name="subtitle"
                                               type="text" value="{{article.sub_title}}" required/>
                                    </div>
                                </div>

                                <div class="form-group ">
                                    <label for="brief" class="control-label col-lg-2">摘要<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                        <textarea class="form-control ckeditor brief" name="brief" rows="6"
                                                  id="brief" required>{{article.brief}}</textarea>
                                    </div>
                                </div>

                                <div class="form-group ">
                                    <label class="control-label col-lg-2">关键字<span
                                            class="required">*</span></label>

                                    <div class="col-lg-10">
                                        {% for kw in kws %}
                                            <div class="col-lg-2 kw">
                                                <input class="form-control keyword" name="keyword" style="margin-bottom: 10px"
                                                    type="text" value="{{kw}}" required/>
                                            </div>
                                        {% endfor %}

                                        <div class="col-lg-1 addkeyword">
                                            <button id="addkeyword" class="btn btn-primary" onclick="MAIN.addkeyword()">添加
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group ">
                                    <label class="control-label col-lg-2">编辑内容<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                        <span id="data-content"  data-content="{{ article.content }}"></span>
                                        <script id="editor" type="text/plain">
                                        </script>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-lg-2">上传附件</label>
                                    <div class="col-lg-10">
                                        {% for file in article.files%}
                                            <div class="col-lg-2" style="margin-bottom: 10px">
                                                <a file_id="{{file.file_id}}" class="btn btn-danger" onclick="MAIN.deletefile(this)">{{file.local_name}}<i class="icon_close_alt2"></i></a>
                                            </div>
                                        {% endfor %}
                                        <div class="col-lg-12">
                                            <input type="file" id="InputFile" multiple="multiple" name="attachment" >
                                            <p class="help-block">上传附件</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-lg-offset-2 col-lg-8">
                                        <button class="btn btn-primary" onclick="MAIN.onSave(0)">保存</button>
                                        <button class="btn btn-default" type="button">取消</button>
                                    </div>
                                    <div class="col-lg-2">
                                        <button class="btn btn-primary" onclick="MAIN.onSave(1)">保存并发布</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                </section>
            </div>
        </div>
    </section>
</section>

<script>

    var MAIN = {};

//    MAIN.ue = UE.getEditor('editor',{
//        serverUrl:"/resources/images"
//    })

    $(function (){
        var ue = UE.getEditor('editor');
        var origin_content = $("#data-content").attr("data-content");
        ue.ready(function () {
            ue.setContent(origin_content);
        });
        window.ue = ue;
    });

    MAIN.init = function () {

    }



    MAIN.addkeyword = function () {
        var kw = $(".kw:first")
        $(".addkeyword").before(kw.clone())
    }

    MAIN.onSave = function (type) {
        var form = new FormData(document.getElementById("articleform"));
        form.append("is_add",1);
        form.append("type",type);
        form.append("article_id",$("#article_id").attr("article_id"));
        var kws = "";
        $(".keyword").each(function () {
            var kw = $(this).val().trim();
            kws += kw + "||"

        });
        form.append("kws",kws.substr(0,kws.length-2))
        $.ajax({
                url:"/back01/saveArticle",
                type:"post",
                data:form,
                processData:false,
                contentType:false,
                success:function(data){
                    alert("success")
                    window.location.reload()
                },
                error:function(e){
                    alert("fail");
                }
            });
    }


    MAIN.deletefile = function (e) {
        var file_id = $(e).attr('file_id');
        var req = {};
        req.file_id = file_id
        Af.rest("/back01/deleteFile",req,function (data) {
            $(e).parent('div:first').remove();
            alert(data)
        })
    }


//    $(document).ready(function () {
//        MAIN.init();
//    });


    //    $(function () {
    //        $('#datetimepicker').datetimepicker({
    //            format: 'YYYY-MM-DD',
    //            locale: moment.locale('zh-cn')
    //        });
    //    });


</script>


{% endblock %}