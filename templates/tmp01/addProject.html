{% extends 'tmp01/base.html' %}

{% block page_name %}首页{% endblock %}

{% block static_files %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='mdeditor/editormd.min.css')}}">

<script src="{{url_for('static',filename='common.js')}}"></script>


<style>
    * {
        box-sizing: border-box;
    }
    body{
        background-color: #f6f6f8;
    }
    .projectContainer{
        background-color: #fff;
        padding:50px;
        min-height: 900px;
        margin: 30px 0 60px 0;

    }

    .item-header{
        height:60px;
        line-height: 60px;
        font-size:20px;
        margin:20px 0;
        border-bottom: 1px dotted #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
    }


    section.content {
        padding: 30px 50px 20px 30px;
        border:1px solid #eee
    }

    section.content input {
        width: 220px;
        height: 30px;
    }

    input#projectTitle {
        width: 500px;
    }

    .tableRow{
        display: flex;
        width: 100%;
        margin: 5px
    }

    .tableRow.btn-group{
        justify-content: flex-end;
    }
    .tableRow label{
        display: inline-block;
        width: 10%;
        flex-shrink: 0;
        padding-right: 5px;
        font-size: 14px;
        font-weight: bold;
    }

    .btn-group button {
        width: 70px;
        height: 40px;
        background-color:#337e0a;
        margin-right: 10px;
        border:0px;
        border-radius: 4px;
        font-size: 16px;
        color:#fff
    }

    .btn-group .cancel {
        background-color: #eee;
        color:#333;
    }
    .hide{
        display: none;
    }

    .show-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .show-header span {
        margin-right: 5px;
        padding:5px;
        font-size:16px;
    }
    .show-content {
        max-height:80px;
        overflow: hidden;
    }

    .operate button {
        margin-left: 5px;
        padding: 5px;
        border: 0px;
        border-radius: 4px;
        background-color: #eee;
        color:#337e0a
    }
</style>

{% endblock%}

{% block body_part%}

<!--项目表单-->
<!--========================-->
<div class="container">
    <div class="row-fluid">
        <div class="projectContainer">
            <div style="display: flex;justify-content: space-between">
                <p>个人中心/上传项目</p>
                <a>预览</a>
            </div>
            <div class="info item">
                <div class="item-header">
                    <div class="left">项目信息</div>
                    <i class="icon-rounded icon-plus add right"></i>
                </div>
                <section class="content hide">
                    <div class="tableRow">
                    <label>项目名称*</label>
                    <input type="text" placeholder="请输入项目名称" id="projectTitle" name="pname">
                </div>
                    <div class="tableRow">
                    <label>项目介绍*</label>
                    <div style="height: 800px;width: 100%;margin-bottom: 15px">
                        <div id="markdown"></div>
                    </div>
                </div>
                    <div class="tableRow">
                    <label>封面图片</label>
                    <input type="file" id="mainPic">
                </div>
                    <div class="tableRow">
                    <label></label>
                    <div style="width:300px;height:200px;background-color: #aaa">
                        <img id="mainPicPreview" style="width:300px;height:200px">
                    </div>
                </div>
                    <div class="tableRow">
                    <label>立项时间*</label>
                    <input type="date" id="projectTime" name="startTime">
                </div>
                    <div class="tableRow">
                    <label>项目专业*</label>
                    <select id="projectMajor" name="academy">
                        <option value="1">通信工程</option>
                        <option value="2">信息工程</option>
                        <option value="3">电子信息工程</option>
                    </select>
                </div>
                    <div class="tableRow">
                    <label>项目类别*</label>
                    <select id="projectCategory" name="type">
                        <option value="1">App开发/微信小程序开发</option>
                        <option value="2">通信/网络</option>
                        <option value="3">软件系统</option>
                        <option value="4">硬件系统</option>
                        <option value="5">视频/图像</option>
                        <option value="6">大数据/机器学习</option>
                    </select>
                </div>
                    <div class="tableRow btn-group">
                        <label></label>
                        <button id="submitInfo">保存</button>
                        <button class="cancel">取消</button>
                    </div>
                </section>
            </div>
            <div id="members">
                <div class="item-header">
                    <div class="left">成员信息</div>
                    <i class="icon-rounded icon-plus add right"></i>
                </div>
                <section class="content hide">
                    <div class="tableRow">
                        <label>姓名</label>
                        <input type="text" id="memberName">
                    </div>
                    <div class="tableRow">
                        <label>学号</label>
                        <input type="text" id="memberNo">
                    </div>
                    <div class="tableRow">
                        <label>班级</label>
                        <input type="text" id="memberClass">
                    </div>
                    <div class="tableRow">
                        <label>年级</label>
                        <input type="text" id="memberGrade">
                    </div>
                    <div class="tableRow">
                        <label>专业</label>
                        <input type="text" id="memberMajor">
                    </div>
                    <div class="tableRow">
                        <label>学院</label>
                        <select id="memberCollege" name="memberCollege">
                            <option value="信息与通信工程学院">信息与通信工程学院</option>
                            <option value="电子工程学院">电子工程学院</option>
                            <option value="数字媒体与设计艺术学院">数字媒体与设计艺术学院</option>
                            <option value="自动化学院">自动化学院</option>
                            <option value="软件学院">软件学院</option>
                            <option value="经济管理学院">经济管理学院</option>
                            <option value="理学院">理学院</option>
                            <option value="人文学院">人文学院</option>
                            <option value="公共管理学院">公共管理学院</option>
                            <option value="国际学院">国际学院</option>
                            <option value="网络教育学院">网络教育学院</option>
                            <option value="民族教育学院和马克思主义教学与研究中心">民族教育学院和马克思主义教学与研究中心</option>
                        </select>
                    </div>
                    <div class="tableRow btn-group">
                        <button id="submitMembers">保存</button><button class="cancel">取消</button>
                    </div>
                </section>
            </div>
            <div id="teachers">
                <div class="item-header">
                    <div class="left">指导老师信息</div>
                    <i class="icon-rounded icon-plus add right"></i>
                </div>
                <section class="content hide">
                    <div class="tableRow">
                        <label>姓名</label>
                        <input type="text" id="teacherName">
                    </div>
                    <div class="tableRow">
                        <label>专业</label>
                        <input type="text" id="teacherMajor">
                    </div>
                    <div class="tableRow">
                        <label>学院</label>
                        <select id="teacherCollege">
                            <option value="信息与通信工程学院">信息与通信工程学院</option>
                            <option value="电子工程学院">电子工程学院</option>
                            <option value="数字媒体与设计艺术学院">数字媒体与设计艺术学院</option>
                            <option value="自动化学院">自动化学院</option>
                            <option value="软件学院">软件学院</option>
                            <option value="经济管理学院">经济管理学院</option>
                            <option value="理学院">理学院</option>
                            <option value="人文学院">人文学院</option>
                            <option value="公共管理学院">公共管理学院</option>
                            <option value="国际学院">国际学院</option>
                            <option value="网络教育学院">网络教育学院</option>
                            <option value="民族教育学院和马克思主义教学与研究中心">民族教育学院和马克思主义教学与研究中心</option>
                        </select>
                    </div>
                    <div class="tableRow btn-group">
                        <button id="submitTeachers">保存</button><button class="cancel">取消</button>
                    </div>
                </section>
            </div>
            <div id="awards">
                <div class="item-header">
                    <div class="left">获奖信息</div>
                    <i class="icon-rounded icon-plus add right"></i>
                </div>
                <section class="content hide">
                    <div class="tableRow">
                            <label>奖项名称</label>
                            <input type="text" id="awardTitle">
                        </div>
                    <div class="tableRow">
                            <label>获奖时间</label>
                            <input type="date" id="awardTime">
                        </div>
                    <div class="tableRow">
                            <label>奖项级别</label>
                            <select id="awardCategory">
                                <option value="1">国际型比赛</option>
                                <option value="2">国家型比赛</option>
                                <option value="3">省部型比赛</option>
                                <option value="4">校内比赛</option>
                            </select>
                        </div>
                    <div class="tableRow">
                        <label>奖项证书</label>
                        <input type="file" multiple id="certfile">
                    </div>
                    <div class="tableRow">
                        <label></label>
                        <div id="certPreview"></div>
                    </div>
                    <div class="tableRow btn-group">
                        <button id="submitAwards">保存</button>
                        <button class="cancel">取消</button>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

{% endblock%}

{% block js_files%}
<script src="{{ url_for('static',filename='mdeditor/editormd.js')}}"></script>


<script type="text/javascript">
    $(function () {
        //更改导航栏的active
        $("li:first").removeClass("active");
        $("li").eq(5).addClass("active");

        // markdown编辑器设置
        var testEditor;

        testEditor = editormd("markdown", {
            syncScrolling: "single",
            saveHTMLToTextarea: true,
            path: "{{url_for('static',filename='mdeditor/lib/')}}",
            //启动本地图片上传功能
            imageUpload: true,
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL: "{{url_for('common.markdown_upload')}}"
        });

        $(".add").click(function () {
            var flag=false;
            $(".content").each(function () {
                if($(this).hasClass("show")){
                   flag=true;         //已经打开一个编辑框
                }
            });
            if(flag){
                alert("当前区域正在被编辑");
            }else{
                var content=$(this).parent().parent().find("section.content");
                content.removeClass("hide");
                content.addClass("show");
            }
        });


        //添加封面图片并预览
        var mainImgPreview=document.getElementById("mainPicPreview");
        var mainPicId;
        var mainfile;
        $("#mainPic").change(function () {
            mainfile=this.files[0];
            var form=new FormData();
            form.append("pics", mainfile);
            form.append("source", 1);
            $.ajax({
                url:'/api/addPic',
                data:form,
                type: 'post',
                dataType: 'json',
                contentType:false,
                processData:false,
                success: function (msg) {
                    mainImgPreview.src=msg.data[0].url;
                    mainPicId=msg.data[0].id;
                }
            });
        });

        //提交项目信息
        var projectId;
        var data={};
        $("#submitInfo").click(function () {
            var parent=$(this).parent().parent();
            if($("#projectTitle").val() && testEditor.getHTML() && $("#projectTime").val() && $("#projectMajor").val() && $("#projectCategory").val()){
                data.pname=$("#projectTitle").val();   //项目名称
                data.content=testEditor.getHTML();     //项目介绍
                data.src_content=testEditor.getMarkdown();
                data.startTime=$("#projectTime").val();  //立项时间
                data.type=$("#projectCategory").val(); //项目类别
                data.mainPicId=mainPicId;              //封面图片id
                data.major=$("#projectMajor").val();  //项目专业
                //console.log(data);
                $.ajax({
                    url:'/api/addPro',
                    data:JSON.stringify(data),
                    type:'post',
                    dataType:'json',
                    success:function (msg) {
                        projectId=msg.data.pid;
                        var newPro=$("<div class='project-show' id='"+projectId+"'></div>");
                        var header=$("<div class='show-header'></div>");
                        newPro.append(header);
                        var header_left=$("<h4>"+data.pname+"</h4>");
                        header.append(header_left);
                        var header_right=$("<div class='btns'><button id='modifyProject' class='modify'>修改</button></div>");
                        header.append(header_right);
                        var content=$("<div class='show-content'></div>");
                        content.html(data.content);
                        newPro.append(content);
                        parent.before(newPro);
                        parent.addClass("hide");
                        parent.removeClass("show");
                    }
                })
            }else{
                alert("必填项不能为空")
            }
        });


        //提交成员信息
        var memberId=[];

        $("#submitMembers").click(function () {
            var item=$(this).parent().parent();
            var member={};
            var name=item.find("#memberName").val();
            var number=item.find("#memberNo").val();
            var classId=item.find("#memberClass").val();
            var grade=item.find("#memberGrade").val();
            var major=item.find("#memberMajor").val();
            var academy=item.find("#memberCollege").val();
            member.name=name;
            member.classId=classId;
            member.number=number;
            member.grade=grade;
            member.major=major;
            member.academy=academy;
            $.ajax({
                url:'/api/addProMember/1/'+projectId,
                data:JSON.stringify(member),
                dataType:'json',
                type:'post',
                success:function (msg) {
                    //console.log(msg);
                    memberId.push(msg.data.mid);
                    var newMember=$("<div class='project-show' id='"+msg.data.mid+"'></div>");
                    var memHeader=$("<div class='show-header'></div>");
                    var headerLeft=$("<div></div>");
                    Object.keys(member).forEach(function (key) {
                        var span=$("<span>"+member[key]+"</span>");
                        headerLeft.append(span);
                    });
                    var btn=$("<div class='operate'><button class='modify modifyMember'>修改</button><button class='deleteMember'>删除</button></div>");
                    memHeader.append(headerLeft);
                    memHeader.append(btn);
                    newMember.append(memHeader);
                    item.before(newMember);
                    item.addClass("hide");
                    item.removeClass("show");
                }
            })

        });

        //删除学生信息
        $("#members").on("click",".deleteMember",function () {
            var aim=$(this).parent().parent().parent();
            var id=aim.attr("id");
            $.ajax({
                url:'/api/deleteProMember/'+id,
                type:'get',
                success:function (msg) {
                    console.log(msg);
                    aim.remove();
                }
            })
        });

        //提交指导老师信息
        var teacherId=[];
        $("#submitTeachers").click(function () {
            var teacher={};
            var teacherItem=$(this).parent().parent();
            teacher.name=teacherItem.find("#teacherName").val();
            teacher.major=teacherItem.find("#teacherMajor").val();
            teacher.academy=teacherItem.find("#teacherCollege").val();
            $.ajax({
                url:'/api/addProMember/0/'+projectId,
                data:JSON.stringify(teacher),
                dataType:'json',
                type:'post',
                success:function (msg) {
                    console.log(msg);
                    teacherId.push(msg.data.mid);
                    var newTeacher=$("<div class='project-show' id='"+msg.data.mid+"'></div>");
                    var teacherHeader=$("<div class='show-header'></div>");
                    var headerLeft=$("<div></div>");
                    Object.keys(teacher).forEach(function (key) {
                        var span=$("<span>"+teacher[key]+"</span>");
                        headerLeft.append(span);
                    });
                    var btn=$("<div class='operate'><button class='modify modifyTeacher'>修改</button><button class='deleteTeacher'>删除</button></div>");
                    teacherHeader.append(headerLeft);
                    teacherHeader.append(btn);
                    newTeacher.append(teacherHeader);
                    teacherItem.before(newTeacher);
                    teacherItem.addClass("hide");
                    teacherItem.removeClass("show");
                }
            })
        });

        //删除指导老师
        $("#teachers").on("click",".deleteTeacher",function () {
            var aim=$(this).parent().parent().parent();
            var id=aim.attr("id");
            $.ajax({
                url:'/api/deleteProTeacher/'+id,
                type:'get',
                success:function (msg) {
                    console.log(msg);
                    aim.remove();
                }
            })
        });

        //添加奖项证书并预览
        var certId=[];
        var certPreview=$("#certPreview");
        var certfile;
        $("#certfile").change(function () {
            var files=this.files;
            certfile=this.files;
            var form=new FormData();
            for(var i=0;i<files.length;i++){
                form.append("pics",files[i]);
            }
            form.append("source", 2);
            $.ajax({
                url:'/api/addPic',
                data:form,
                type: 'post',
                dataType: 'json',
                contentType:false,
                processData:false,
                success:function (msg) {
                    for(var i=0;i<msg.data.length;i++){
                        var certImg=document.createElement("img");
                        certImg.src=msg.data[i].url;
                        certImg.width=210;
                        certImg.height=140;
                        certPreview.append(certImg);
                        certId.push(msg.data[i].id)
                    }
                    console.log(certId)
                }
            })
        });

        //删除证书图片

        //提交奖项
        $("#submitAwards").click(function () {
            var award={};
            var awardItem=$(this).parent().parent();
            award.title=awardItem.find("#awardTitle").val();
            award.rank=awardItem.find("#awardCategory").val();
            award.awardTime=awardItem.find("#awardTime").val();
            award.certids=certId;
            $.ajax({
                url:'/api/addProAward/'+projectId,
                data:JSON.stringify(award),
                dataType:'json',
                type:'post',
                success:function (msg) {
                    console.log(msg);
                    var newAward=$("<div class='project-show' id='"+msg.data.mid+"'></div>");
                    var awardHeader=$("<div class='show-header'></div>");
                    var headerLeft=$("<div><span>"+award.title+"</span><span>"+award.awardTime+"</span></div>");
                    var btn=$("<div class='operate'><button class='modify modifyAward'>修改</button><button class='deleteAward'>删除</button></div>");
                    awardHeader.append(headerLeft);
                    awardHeader.append(btn);
                    newAward.append(awardHeader);
                    awardItem.before(newAward);
                    awardItem.addClass("hide");
                    awardItem.removeClass("show");
                }
            })
        });

        //删除奖项
        $("#awards").on("click",".deleteAward",function () {
            var aim=$(this).parent().parent().parent();
            var id=aim.attr("id");
            $.ajax({
                url:'/api/deleteProAward/'+id,
                type:'get',
                success:function (msg) {
                    console.log(msg);
                    aim.remove();
                }
            })
        });

        //取消编辑
        $(".cancel").click(function () {
            $(this).parent().parent().addClass("hide");
            $(this).parent().parent().removeClass("show");
        });




    })
</script>

{% endblock %}